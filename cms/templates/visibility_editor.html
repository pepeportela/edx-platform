<%
from django.utils.translation import ugettext as _
from contentstore.utils import ancestor_has_staff_lock, get_visibility_partition_info

partition_info = get_visibility_partition_info(xblock)
selectable_partitions = partition_info["selectable_partitions"]
selected_partition_index = partition_info["selected_partition_index"]

is_staff_locked = ancestor_has_staff_lock(xblock)
%>

<div class="modal-section visibility-summary">
    % if len(selectable_partitions) == 0:
        ## TODO: do we wish to change this message at all to say that there are not multiple enrollment tracks?
        <div class="is-not-configured has-actions">
            <h4 class="title">${_('No content groups exist')}</h4>

            <div class="copy">
                <p>${_('Use content groups to give groups of students access to a specific set of course content. Create one or more content groups, and make specific components visible to them.')}</p>
            </div>

            <div class="actions">
                <a href="${manage_groups_url}" class="action action-primary action-settings">${_('Manage content groups')}</a>
            </div>
        </div>
    % elif is_staff_locked:
        <div class="summary-message summary-message-warning visibility-summary-message">
            <span class="icon fa fa-exclamation-triangle" aria-hidden="true"></span>
            <p class="copy">
                ## Translators: Any text between {screen_reader_start} and {screen_reader_end} is only read by screen readers and never shown in the browser.
                ${_(
                    "{screen_reader_start}Warning:{screen_reader_end} The Unit this component is contained in is hidden from students. Visibility settings here will be trumped by this."
                    ).format(
                        screen_reader_start='<span class="sr">',
                        screen_reader_end='</span>',
                    )
                }
            </p>
        </div>
    % endif
</div>

% if len(selectable_partitions) > 0:
    <form class="visibility-controls-form" method="post" action="">
        <div role="group" aria-labelledby="visibility-title">
        <div class="modal-section visibility-controls">
            <h3 class="modal-section-title" id="visibility-title">${_('Make visible to:')}</h3>
            <div class="modal-section-content partition-visibility">
            <select aria-labelledby="visibility-title">
                <option value="-1" ${'selected="selected"' if selected_partition_index == -1 else ''}>
                    ${_('All Learners and Staff')}
                </option>
                % for index, partition in enumerate(selectable_partitions):
                    <option value="${partition["id"]}" id="visibility-partition-${partition["id"]}" ${'selected="selected"' if selected_partition_index == index else ''}>
                        ${partition["name"]}
                    </option>
                % endfor
            </select>

            % for index, partition in enumerate(selectable_partitions):
                <div class="partition-group-control partition-group-control-${partition["id"]} ${'is-hidden' if selected_partition_index != index else ''}">
                    <div class="partition-group-directions" id="partition-group-directions-${partition["id"]}">${_('Select one or more options:')}
                    % for group in partition["groups"]:
                        <div role="group" aria-labelledby="visibility-partition-${partition["id"]}" aria-describedby="partition-group-directions-${partition["id"]}"
                            class="field partition-group-visibility partition-group-visibility-${partition["id"]} ${'was-removed' if group["deleted"] else ''}">
                            <input type="checkbox"
                                id="visibility-group-${partition["id"]}-${group["id"]}"
                                name="visibility-group"
                                value="${group["id"]}"
                                class="input input-checkbox"
                                ${'checked="checked"' if group["selected"] else ''}
                            />
                            % if group["deleted"]:
                            <label for="visibility-group-${partition["id"]}-${group["id"]}" class="label">
                                ${_("Deleted Group")}
                                <span class="note">${_('This group no longer exists. Please choose another or allow access to All Learners and Staff.')}</span>
                            </label>
                            % else:
                            <label for="visibility-group-${partition["id"]}-${group["id"]}" class="label">${group["name"] | h}</label>
                            % endif
                         </div>
                    % endfor
                    </div>
                </div>
            % endfor
            </div>
        </div>
    </form>
% endif